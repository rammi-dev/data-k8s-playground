graph LR
    %% ===========================================
    %% DREMIO STORAGE ARCHITECTURE (Ceph S3 + PVCs)
    %% ===========================================

    subgraph Components["Dremio Components"]
        direction TB
        Master["dremio-master"]
        Standby["dremio-coordinator"]
        Exec["dremio-executor (1 replica)"]
        Catalog["catalog-server"]
        EngineOp["engine-operator"]
    end

    spacer1[ ]
    spacer2[ ]

    subgraph Infrastructure["Infrastructure Services"]
        direction TB
        ZK["ZooKeeper (1 replica)<br/>:2181/TCP"]
        NATS["NATS (1 replica)<br/>:4222/TCP"]
        MongoDB["MongoDB (1 replica)<br/>:27017/TCP"]
        MongoOp["MongoDB Operator<br/>(Percona)"]
    end

    subgraph CoordStorage["Coordinator PVCs"]
        direction TB
        CoordData["dremio-master-volume<br/>10Gi (ceph-block)<br/>/opt/dremio/data/<br/>db/, results/, security/"]
        CoordLogs["dremio-log-volume<br/>10Gi (ceph-block)<br/>/opt/dremio/log/"]
    end

    subgraph ExecStorage["Executor PVCs (per pod)"]
        direction TB
        ExecSpill["executor-volume<br/>10Gi (ceph-block)<br/>/opt/dremio/data/<br/>log/, results/, spill/"]
        ExecC3["executor-c3<br/>10Gi (ceph-block)<br/>/opt/dremio/cloudcache/c0/"]
        ExecLogs["dremio-log-volume<br/>10Gi (ceph-block)<br/>/opt/dremio/log/"]
    end

    subgraph InfraStorage["Infrastructure PVCs"]
        direction TB
        ZKData["datadir-zk-*<br/>10Gi (ceph-block)<br/>/data/"]
        NATSData["nats-js-*<br/>2Gi (ceph-block)<br/>/data/jetstream/"]
        MongoData["mongod-data-*<br/>10Gi (ceph-block)<br/>/data/db/"]
    end

    subgraph CephS3["Ceph S3 (rook-ceph namespace)"]
        direction TB
        RGW["RGW Gateway<br/>rook-ceph-rgw-s3-store:80"]
        subgraph BucketDremio["bucket: dremio"]
            direction LR
            DAccel["/accelerator/"]
            DData["/data/results_cache/"]
            DDownloads["/downloads/"]
            DMetadata["/metadata/"]
            DNodeHist["/node_history/"]
            DProfile["/profile/"]
            DScratch["/scratch/"]
            DSysIceberg["/system_iceberg_tables/"]
            DUploads["/uploads/"]
            DMongoBackup["/catalog-backups/<br/>(MongoDB PITR + full)"]
        end
        subgraph BucketCatalog["bucket: dremio-catalog"]
            direction LR
            CData["/ns/table/data/"]
            CMeta["/ns/table/metadata/"]
        end
    end

    %% Spacer connections (invisible)
    Master ~~~ spacer1
    spacer1 ~~~ Infrastructure
    Exec ~~~ spacer2
    spacer2 ~~~ ExecStorage

    %% Coordinator connections
    Master --> CoordData
    Master --> CoordLogs

    %% Executor connections
    Exec --> ExecSpill
    Exec --> ExecC3
    Exec --> ExecLogs

    %% Component connections to infrastructure
    Master --> ZK
    Master --> NATS
    Master --> MongoDB
    Standby -.-> ZK
    Exec --> ZK
    Catalog --> MongoDB

    %% Infrastructure to PVCs
    ZK --> ZKData
    NATS --> NATSData
    MongoDB --> MongoData

    %% Dremio distStorage -> bucket: dremio
    Master -->|"S3 API<br/>(distStorage)"| BucketDremio
    Exec -->|"S3 API<br/>(distStorage)"| BucketDremio

    %% Catalog -> bucket: dremio-catalog (Iceberg/Polaris)
    Catalog -->|"S3 API<br/>(catalog.storage)"| BucketCatalog

    %% MongoDB backup -> bucket: dremio (subfolder)
    MongoDB -->|"S3 API<br/>(Percona backup)"| DMongoBackup

    %% C3 caches S3
    ExecC3 -.->|"caches"| BucketDremio

    %% Styling
    classDef component fill:#4dabf7,stroke:#1971c2,stroke-width:2px,color:#fff
    classDef infra fill:#ff922b,stroke:#e8590c,stroke-width:2px,color:#fff
    classDef pvc fill:#ffd43b,stroke:#f59f00,stroke-width:2px,color:#000
    classDef ceph fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px,color:#fff
    classDef bucket fill:#ffa8a8,stroke:#c92a2a,stroke-width:1px,color:#000
    classDef invisible fill:none,stroke:none,color:transparent

    class Master,Standby,Exec,Catalog,EngineOp component
    class ZK,NATS,MongoDB,MongoOp infra
    class CoordData,CoordLogs,ExecSpill,ExecC3,ExecLogs,ZKData,NATSData,MongoData pvc
    class RGW ceph
    class DAccel,DData,DDownloads,DMetadata,DNodeHist,DProfile,DScratch,DSysIceberg,DUploads,DMongoBackup,CData,CMeta bucket
    class spacer1,spacer2 invisible
